const express = require('express');\nconst puppeteer = require('puppeteer');\nconst Tesseract = require('tesseract.js');\nconst multer = require('multer');\nconst cors = require('cors');\nconst path = require('path');\nconst fs = require('fs');\nconst pdf = require('pdf-parse');\nrequire('dotenv').config();\n\nconst app = express();\nconst port = process.env.PORT || 3000;\n\napp.use(cors());\napp.use(express.json());\napp.use(express.static('public'));\n\nconst upload = multer({ dest: 'uploads/' });\n\nlet products = [];\n\nconst competitors = [\n  {\n    name: 'BijelaTehnika',\n    searchUrl: q => 'https://www.bijelatehnika.com/search?q=' + encodeURIComponent(q),\n    priceSelector: '.product-price'\n  },\n  {\n    name: 'Tehnomag',\n    searchUrl: q => 'https://www.tehnomag.ba/pretraga?query=' + encodeURIComponent(q),\n    priceSelector: '.price'\n  }\n];\n\nasync function extractText(filePath) {\n  if (filePath.endsWith('.pdf')) {\n    const buffer = fs.readFileSync(filePath);\n    const data = await pdf(buffer);\n    if (!data.text || data.text.length < 50) {\n      return await ocrImage(filePath);\n    }\n    return data.text;\n  }\n  return await ocrImage(filePath);\n}\n\nasync function ocrImage(filePath) {\n  const { data } = await Tesseract.recognize(filePath, 'bos+eng');\n  return data.text;\n}\n\nfunction normalizeName(name) {\n  return name\n    .replace(/\\b(R1|R2|R3|PDV|%|KOM)\\b/gi, '')\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\nfunction parseProducts(text) {\n  const lines = text.split('\\n').map(l => l.trim()).filter(Boolean);\n  const parsedProducts = [];\n  for (let line of lines) {\n    const priceMatch = line.match(/(\\d{1,3}(\\.\\d{3})*,\\d{2})/);\n    if (!priceMatch) continue;\n    const price = parseFloat(priceMatch[1].replace(/\\./g, '').replace(',', '.'));\n    const name = line.replace(priceMatch[1], '').trim();\n    if (name.length > 5) {\n      parsedProducts.push({\n        product: normalizeName(name),\n        myPrice: price,\n        timestamp: new Date().toISOString(),\n        id: Date.now() + Math.random()\n      });\n    }\n  }\n  return parsedProducts;\n}\n\nasync function scrapeCompetitorPrice(url, selector) {\n    let browser;\n    try {\n        browser = await puppeteer.launch({\n            args: ['--no-sandbox', '--disable-setuid-sandbox'],\n            executablePath: process.env.PUPPETEER_EXECUTABLE_PATH || null\n        });\n        const page = await browser.newPage();\n        await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });\n        const priceText = await page.$eval(selector, el => el.innerText);\n        const price = parseFloat(priceText.replace(/[^0-9,.]/g, '').replace(',', '.'));\n        return price;\n    } catch (error) {\n        console.error('Error scraping ' + url + ':', error);\n        return null;\n    } finally {\n        if (browser) await browser.close();\n    }\n}\n\napp.get('/api/products', (req, res) => {\n    res.json({\n        products: products,\n        page: 1,\n        totalPages: 1\n    });\n});\n\napp.post('/api/products/manual', (req, res) => {\n    const { name, price } = req.body;\n    const product = {\n        id: Date.now(),\n        product: name,\n        myPrice: price,\n        timestamp: new Date().toISOString(),\n        competitors: {}\n    };\n    products.push(product);\n    res.status(201).json({ success: true, product });\n});\n\napp.post('/api/products/ocr', upload.single('file'), async (req, res) => {\n  try {\n    const filePath = req.file.path;\n    const text = await extractText(filePath);\n    const newProducts = parseProducts(text);\n    products = [...products, ...newProducts];\n    fs.unlinkSync(filePath);\n    res.json({ success: true, productsAdded: newProducts.length });\n  } catch (error) {\n    console.error('Upload error:', error);\n    res.status(500).json({ error: 'Failed to process document' });\n  }\n});\n\napp.post('/api/products/:id/refresh', async (req, res) => {\n    const product = products.find(p => p.id == req.params.id);\n    if (!product) return res.status(404).json({ error: 'Not found' });\n    product.competitors = {};\n    for (const comp of competitors) {\n        const price = await scrapeCompetitorPrice(comp.searchUrl(product.product), comp.priceSelector);\n        product.competitors[comp.name] = {\n            price,\n            found: !!price,\n            url: comp.searchUrl(product.product)\n        };\n    }\n    res.json({ success: true });\n});\n\napp.delete('/api/products/:id', (req, res) => {\n    products = products.filter(p => p.id != req.params.id);\n    res.json({ success: true });\n});\n\napp.listen(port, () => {\n    console.log('Server running on port ' + port);\n});